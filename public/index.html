<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kodachs - Your Data Quality Consultant</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --fur-dark:#2c2c2c;
      --fur-light:#f0f0f0;
      --accent:#6b8cff;
      --muted:#6c7080;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,"Helvetica Neue",Arial; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg); color:#21303b}

    .app{max-width:95%; background:white; border-radius:14px; box-shadow:0 8px 30px rgba(33,48,59,0.08); padding:28px; display:flex; gap:28px; align-items:center}

    .challenge-instruction-box{
      position: absolute;
      top:0;
    }

    /* Dachs */
    .badger-wrap{width:240px; display:flex; flex-direction:column; align-items:center}
    .badger{
      width:180px; height:160px; background:var(--fur-dark); border-radius:90px 90px 60px 60px / 100px 100px 40px 40px; position:relative; box-shadow:0 8px 20px rgba(0,0,0,0.1); transition:transform .3s ease;
    }
    .badger:hover{transform:translateY(-6px) scale(1.03)}

    .stripe{
      position:absolute; top:0; width:30px; height:100%; background:var(--fur-light);
    }
    .stripe.left{left:40px; border-radius:40px 0 0 40px / 100px 0 0 60px;}
    .stripe.right{right:40px; border-radius:0 40px 40px 0 / 0 100px 60px 0;}

    .eye{position:absolute; top:60px; width:20px; height:20px; background:black; border-radius:50%;}
    .eye.left{left:50px;}
    .eye.right{right:50px;}

    .nose{position:absolute; bottom:28px; left:50%; transform:translateX(-50%); width:36px; height:28px; background:black; border-radius:50% 50% 60% 60%;}

    .mouth{position:absolute; bottom:18px; left:50%; transform:translateX(-50%); width:60px; height:10px; border-bottom:3px solid black; border-radius:0 0 50% 50%;}

    /* Chatbereich */
    .chat{
      flex:1; min-height:160px; display:flex; flex-direction:column; gap:12px
    }
    .title{font-weight:600; margin-bottom:6px}
    .panel{flex:1; background:#e8f0ff; border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:10px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}

    .setup-popup{
      padding:10px 12px; border-radius:10px; background:white; box-shadow:0 6px 18px rgba(33,48,59,0.04); font-size:15px; color:#17202b    }

    .response{min-height:68px; padding:10px 12px; border-radius:10px; background:white; box-shadow:0 6px 18px rgba(33,48,59,0.04); font-size:15px; color:#17202b}

    .controls{display:flex; gap:8px; margin-top:8px; pointer-events: none;}
    input[type=text]{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e3e8f2; font-size:14px}
    button{padding:10px 14px; border-radius:10px; border:0; background:var(--accent); color:white; font-weight:600; cursor:pointer}
    button:active{transform:translateY(1px)}

    #token{
        position:absolute;
        bottom:0;
    }

    .typing-dots{display:flex; gap:6px; align-items:center}
    .dot{width:8px; height:8px; background:#21303b; border-radius:50%; opacity:0.2; transform:translateY(0); animation:dot 1s infinite}
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes dot{0%{opacity:.2; transform:translateY(0)}50%{opacity:1; transform:translateY(-6px)}100%{opacity:.2; transform:translateY(0)}}
  
    .debug-inputs{
      width: 90%;
      position:relative;
      clear:both;
    }
  </style>
</head>
<body>
  <div class="challenge-instruction-box">
    <h1>Can Your Project win the Kodachs Data Quality Award?</h1>
    <p>Study task can go here, as reminder.</p>
  </div>
  
  <div class="app" role="application" aria-label="Dachs Chatbot Demo">
    <div class="badger-wrap">
      <div class="badger" id="badger">
        <div class="stripe left"></div>
        <div class="stripe right"></div>
        <div class="eye left" id="eyeL"></div>
        <div class="eye right" id="eyeR"></div>
        <div class="nose"></div>
        <div class="mouth" id="mouth"></div>
      </div>
      <div style="margin-top:12px; text-align:center; color:var(--muted); font-size:13px">Kodachs</div>
    </div>

    <div class="chat">
      <div class="title">Ask The Kodachs A Question</div>
      <div class="panel">
        <div class="setup-popup">
          <p>To talk to the Kodachs Data Quality Consultant, please choose your anonymous identifier below and read and accept the <a href="/termsofuse.html" target="_blank">terms of use</a>.</p>
          <form id="setupForm" >
            <input id="tou" name="tou" type="checkbox"/>
            <label for="tou">I have read and accept the terms of use</label>    
            <p></p>    
            <label for="userId">First two letters of mother's first name, Day of your birth (two digits), Last two digits of your phone number</label>
            <input name="userId" type="text"/>
           
            <p></p>          
            
          </form>
           <button type="submit" onclick="onSetupFormSubmit()">OK</button>
        </div>
        <div id="response" class="response">Hello, I am your Kodachs! Ask me something and press Enter or Send.</div>
        <div class="controls">
          <input id="input" type="text" placeholder="Type Your Question Here..." aria-label="Input for Your Question" />
          <button id="send">Send</button>
        </div>
      </div>
    </div>
  </div>

   <div class="debug-inputs">
    <p><b>prompt structure:</b></p>
    <p>some instructions before the user's query:</p>
    <textarea style="width:100%" id="prompt-structure-input-1" rows="5">You are a tutor that assists students with the KODAQS Data Quality Academy. The given files are the slides of the course. Please answer the following student question in no more than 5 sentences:</textarea>
    <p><b><i>the user's query will be inserted here</i></b></p>
    <p>some instructions after the user's query could go here</p>
    <textarea style="width:100%" id="prompt-structure-input-2" rows="5"></textarea>
    <p><b><i>The chat's message history will be added here</i></b></p>

    <p>RAG ids, that the model should consider (files need to be uploaded to the used API account before!):</p>
    <textarea id="ragRefs" style="width:100%", rows="10">
      [
                    {"type": "file", "id": "e1bac6a7-2cf2-42e5-bdf2-65f80f2f5998"},
                    {"type": "file", "id": "d0b0e241-2f0b-40c1-a4af-4fb061493cec"},
                    {"type": "file", "id": "da10aa97-c5e7-4e26-aeb7-5ab871db661e"},
                    {"type": "file", "id": "fa972a94-9530-476d-bcb9-29221b5f5117"},
                    {"type": "file", "id": "4fa325c3-dfec-4315-a5e4-b51822b4ae79"},
                    {"type": "file", "id": "e583d6d1-fdca-4bd0-9918-3b76ad2f0956"}
                ]</textarea>
  </div>
  
  
  <script>
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const response = document.getElementById('response');
    const mouth = document.getElementById('mouth');
    const tokenInput = document.getElementById('tokenInput');

    function setTypingState(on){
      if(on){
        response.innerHTML = '<div class="typing-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
        mouth.style.borderBottom = 'none';
      } else {
        mouth.style.borderBottom = '3px solid black';
      }
    }

   

    /**
     * Call mediated through our server middleware
     */
    async function aiMiddlewareAnswer(text){

        let promptStructure1 = document.getElementById("prompt-structure-input-1").value;
        console.log(promptStructure1);
        let promptStructure2 = document.getElementById("prompt-structure-input-2").value;
        console.log(promptStructure2);
        let ragRefs = document.getElementById("ragRefs").value;
        console.log(ragRefs);

        let postReqBody = {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({                
                    "question": text,
                    "userId": localStorage.getItem("kodachsUserId"),
                    "promptStructure1": promptStructure1,
                    "promptStructure2": promptStructure2,
                    "ragRefs": ragRefs
                })
        };
        console.log(postReqBody);

        let reqResponse = await fetch("/query",postReqBody);
        let data = await reqResponse.json();
        console.log(data);
        let resText = data.answer;
        response.textContent = resText;
        input.value = '';
       input.disabled = false; send.disabled = false; input.focus();
       setTypingState(false);
        return resText;
    }

    function simpleBotAnswer(text){
      const t = text.trim().toLowerCase();
      if(!t) return 'Bitte stelle eine Frage.';
      if(t.includes('hallo') || t.includes('hi')) return 'Hallo! Ich bin der Dachs‑Bot.';
      if(t.includes('wie geht')) return 'Mir geht es dachs‑tastisch!';
      if(t.includes('wer bist') || t.includes('was bist')) return 'Ich bin ein freundlicher Dachs‑Chatbot.';
      return 'Ich bin nur ein kleiner Dachs‑Bot. Du sagtest: "' + text + '"';
    }

    async function handleSend(){
      const q = input.value;
      if(!q.trim()) return;
      setTypingState(true);
      input.disabled = true; send.disabled = true;
    //  await new Promise(r => setTimeout(r, 30000));//900 + Math.min(1200, q.length * 40)));
      const answer = aiMiddlewareAnswer(q);
      //response.textContent = answer;
      blinkEyes();
      input.value = '';
      input.disabled = false; send.disabled = false; input.focus();
      setTypingState(false);
    }

    function blinkEyes(){
      const left = document.getElementById('eyeL');
      const right = document.getElementById('eyeR');
      left.style.transform = 'scaleY(0.2)';
      right.style.transform = 'scaleY(0.2)';
      left.style.transition = 'transform 120ms';
      right.style.transition = 'transform 120ms';
      setTimeout(()=>{ left.style.transform = ''; right.style.transform = ''; }, 200);
    }

    send.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handleSend(); });


    // study mgmt
    function onSetupFormSubmit(e){
      console.log('setup form submitted')
      //e.preventDefault();
      let agreedTou = document.querySelector("input[name='tou']").checked; 
      let enteredUserId = document.querySelector("input[name='userId']").value; 

      if (!agreedTou){
        alert("You have to enter your userId and accept the Terms of Use, in order to use the Kodachs Data Quality Consultant");
      }
      else if(""==enteredUserId){
        alert("Please enter a valid identifier");
      } else {        
        signupCompleted(enteredUserId);
      }
    }

    function signupCompleted(userId){
      localStorage.setItem("kodachsUserId", userId);
      makeKodachsAvailable();
    }


    // to be called either on setup completed, or after a reload when the userId is in localStorage
    function makeKodachsAvailable(){
      document.querySelector(".setup-popup").style.display="none";
      document.querySelector(".controls").style.pointerEvents = "auto";  //enables the chat
    }

    addEventListener("DOMContentLoaded", (event) => { 
      checkIfUserIsSetup();
    });

    function checkIfUserIsSetup(){
      if(localStorage.getItem("kodachsUserId") === null){
        // user not setup yet
        console.log("user is not setup yet");
      }
      else {
        console.log("user setup completed");
        makeKodachsAvailable();
      }
    }
  </script>
</body>
</html>
