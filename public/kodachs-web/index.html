<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dachs-Chatbot (Demo)</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --fur-dark:#2c2c2c;
      --fur-light:#f0f0f0;
      --accent:#6b8cff;
      --muted:#6c7080;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,"Helvetica Neue",Arial; margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--bg); color:#21303b}

    .app{width:600px; max-width:95%; background:white; border-radius:14px; box-shadow:0 8px 30px rgba(33,48,59,0.08); padding:28px; display:flex; gap:28px; align-items:center}

    /* Dachs */
    .badger-wrap{width:240px; display:flex; flex-direction:column; align-items:center}
    .badger{
      width:180px; height:160px; background:var(--fur-dark); border-radius:90px 90px 60px 60px / 100px 100px 40px 40px; position:relative; box-shadow:0 8px 20px rgba(0,0,0,0.1); transition:transform .3s ease;
    }
    .badger:hover{transform:translateY(-6px) scale(1.03)}

    .stripe{
      position:absolute; top:0; width:30px; height:100%; background:var(--fur-light);
    }
    .stripe.left{left:40px; border-radius:40px 0 0 40px / 100px 0 0 60px;}
    .stripe.right{right:40px; border-radius:0 40px 40px 0 / 0 100px 60px 0;}

    .eye{position:absolute; top:60px; width:20px; height:20px; background:black; border-radius:50%;}
    .eye.left{left:50px;}
    .eye.right{right:50px;}

    .nose{position:absolute; bottom:28px; left:50%; transform:translateX(-50%); width:36px; height:28px; background:black; border-radius:50% 50% 60% 60%;}

    .mouth{position:absolute; bottom:18px; left:50%; transform:translateX(-50%); width:60px; height:10px; border-bottom:3px solid black; border-radius:0 0 50% 50%;}

    /* Chatbereich */
    .chat{
      flex:1; min-height:160px; display:flex; flex-direction:column; gap:12px
    }
    .title{font-weight:600; margin-bottom:6px}
    .panel{flex:1; background:#e8f0ff; border-radius:12px; padding:14px; display:flex; flex-direction:column; gap:10px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6)}

    .response{min-height:68px; padding:10px 12px; border-radius:10px; background:white; box-shadow:0 6px 18px rgba(33,48,59,0.04); font-size:15px; color:#17202b}

    .controls{display:flex; gap:8px; margin-top:8px}
    input[type=text]{flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e3e8f2; font-size:14px}
    button{padding:10px 14px; border-radius:10px; border:0; background:var(--accent); color:white; font-weight:600; cursor:pointer}
    button:active{transform:translateY(1px)}

    #token{
        position:absolute;
        bottom:0;
    }

    .typing-dots{display:flex; gap:6px; align-items:center}
    .dot{width:8px; height:8px; background:#21303b; border-radius:50%; opacity:0.2; transform:translateY(0); animation:dot 1s infinite}
    .dot:nth-child(2){animation-delay:0.15s}
    .dot:nth-child(3){animation-delay:0.3s}
    @keyframes dot{0%{opacity:.2; transform:translateY(0)}50%{opacity:1; transform:translateY(-6px)}100%{opacity:.2; transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Dachs Chatbot Demo">
    <div class="badger-wrap">
      <div class="badger" id="badger">
        <div class="stripe left"></div>
        <div class="stripe right"></div>
        <div class="eye left" id="eyeL"></div>
        <div class="eye right" id="eyeR"></div>
        <div class="nose"></div>
        <div class="mouth" id="mouth"></div>
      </div>
      <div style="margin-top:12px; text-align:center; color:var(--muted); font-size:13px">Kodachs</div>
    </div>

    <div class="chat">
      <div class="title">Stell dem Kodachs eine Frage</div>
      <div class="panel">
        <div id="response" class="response">Hallo, ich bin dein Kodachs! Frag mich etwas und drücke Enter oder Senden.</div>
        <div class="controls">
          <input id="input" type="text" placeholder="Schreibe hier deine Frage..." aria-label="Eingabefeld für Frage" />
          <button id="send">Senden</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const response = document.getElementById('response');
    const mouth = document.getElementById('mouth');
    const tokenInput = document.getElementById('tokenInput');

    function setTypingState(on){
      if(on){
        response.innerHTML = '<div class="typing-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
        mouth.style.borderBottom = 'none';
      } else {
        mouth.style.borderBottom = '3px solid black';
      }
    }

   

    /**
     * Call mediated through our server middleware
     */
    async function aiMiddlewareAnswer(text){
        let reqResponse = await fetch("/query",{
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({                
                    "question": text
                })
        });
        let data = await reqResponse.json();
        console.log(data);
        let resText = data.answer;
        response.textContent = resText;
        input.value = '';
      input.disabled = false; send.disabled = false; input.focus();
      setTypingState(false);
        return resText;
    }

    function simpleBotAnswer(text){
      const t = text.trim().toLowerCase();
      if(!t) return 'Bitte stelle eine Frage.';
      if(t.includes('hallo') || t.includes('hi')) return 'Hallo! Ich bin der Dachs‑Bot.';
      if(t.includes('wie geht')) return 'Mir geht es dachs‑tastisch!';
      if(t.includes('wer bist') || t.includes('was bist')) return 'Ich bin ein freundlicher Dachs‑Chatbot.';
      return 'Ich bin nur ein kleiner Dachs‑Bot. Du sagtest: "' + text + '"';
    }

    async function handleSend(){
      const q = input.value;
      if(!q.trim()) return;
      setTypingState(true);
      input.disabled = true; send.disabled = true;
    //  await new Promise(r => setTimeout(r, 30000));//900 + Math.min(1200, q.length * 40)));
      const answer = aiMiddlewareAnswer(q);
      //response.textContent = answer;
      blinkEyes();
      input.value = '';
      input.disabled = false; send.disabled = false; input.focus();
      setTypingState(false);
    }

    function blinkEyes(){
      const left = document.getElementById('eyeL');
      const right = document.getElementById('eyeR');
      left.style.transform = 'scaleY(0.2)';
      right.style.transform = 'scaleY(0.2)';
      left.style.transition = 'transform 120ms';
      right.style.transition = 'transform 120ms';
      setTimeout(()=>{ left.style.transform = ''; right.style.transform = ''; }, 200);
    }

    send.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') handleSend(); });
  </script>
</body>
</html>
